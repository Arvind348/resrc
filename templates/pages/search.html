{% extends "base.html" %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block title %}
Search by tags
{% endblock %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{% static "js/selectize/css/selectize.css" %}" />
{% endblock %}

{% block breadcrumb %}
<li><a href="{% url "home" %}">Home</a></li>
<li><a href="{% url "tag-index" %}">Tags</a></li>
<li class="current">Search</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="large-12 columns">
    <h1 id="query">Search by tags</h1>
  </div>
</div>

<div class="row">
  <div class="medium-2 columns">
    <div class="switch">
      <input name="op" id="op-or" value="or" type="radio"{% if sop != 'and' %} checked="checked"{% endif %}>
      <label for="x" onclick="">Or</label>

      <input name="op" id="op-and" value="and" type="radio"{% if sop == 'and' %} checked="checked"{% endif %}>
      <label for="x1" onclick="">And</label>

      <span></span>
    </div>
  </div>
  <div class="medium-10 columns">
    <input type="text" id="selected-tags" value="{{ stags }}" placeholder="Start entering tags" />
  </div>
</div>

<div class="row">
  <div class="medium-2 columns">
    <label for="excluded-tags" class="inline">
      exclude tags :
    </label>
  </div>
  <div class="medium-10 columns">
    <input type="text" id="excluded-tags" value="{{ sex }}" placeholder="Start entering tags" />
  </div>
</div>

<div class="row">
  <div class="large-6 columns">
    <h4>Links</h4>
    <div id="link_results"></div>
  </div>
  <div class="large-6 columns">
    <h4>Lists</h4>
    <div id="list_results"></div>
  </div>
</div>

{% endblock %}

{% block last_body %}
<script src="{% static "js/selectize/js/standalone/selectize.min.js" %}"></script>
<script>
  var _gaq = _gaq || [];

  $(function () {

    var selectizeOptions = {
      openOnFocus: false,
      highlight: true,
      hideSelected: true,
      valueField: 'tag',
      labelField: 'tag',
      searchField: ['tag'],
      options: {{ tags_json|safe }},
      onChange: search,
      onInitialize: search,
    };

    $('#selected-tags').selectize(selectizeOptions);
    $('#excluded-tags').selectize(selectizeOptions);

    $('input[name="op"]').on('change', search);

    $('#selected-tags').siblings('.selectize-control').find('input').focus();


    function search (selectedTags) {
      var op = $('input[name="op"]:checked').val(),
          selectedTags = $('#selected-tags').val(),
          excludedTags = $('#excluded-tags').val(),
          url = '/search/' + selectedTags +'%25' + op + '%25' + excludedTags,
          query = buildQueryString(selectedTags, excludedTags, op);

      if (query.length === 0) {
        $('#query').html('Search by tags');
      }
      else {
        $('#query').html('<a href="/page' + url + '">' + query + '</a>');

        _gaq.push(['_trackEvent', 'Search', 'Searchpage', query]);

        $.ajax({
          type:'GET',
          url: '/tag' + url,
          success: function (result) {
            result = $.parseJSON(result);
            injectResults($('#link_results'), result[0]);
            injectResults($('#list_results'), result[1]);
          }
        });
      }
    };

    function resultLayoutTpl (content) {
      return '<div class="panel"><h5>' + content + '</h5></div>';
    };

    function resultTpl (index, content) {
      var content = index + '. <a href="' + content.url + '">' + content.title + '</a>';
      return resultLayoutTpl(content);
    };

    function injectResults ($element, results) {
      $element.empty();
      if (!results.length) {
        $element.append(resultLayoutTpl('Sorry, no result.'));
      }
      else {
        results.forEach(function (result, index) {
          $element.append(resultTpl(index, result));
        });
      }
    };

    function buildQueryString (selectedTags, excludedTags, operand) {
      var query = '';
      if (selectedTags !== '') {
        var tags = selectedTags.split(',');
        var operandSep = operand === 'and' ? ' & ' : ' | ';
        query += tags.join(operandSep);
      }
      if (excludedTags !== '') {
        var excludes = excludedTags.split(',');
        query += ' ~(';
        query += excludes.join(' | ');
        query += ')';
      }
      return query;
    };

  });
</script>
{% endblock last_body %}
